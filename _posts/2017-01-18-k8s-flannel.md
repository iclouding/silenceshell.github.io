---
layout: post
title: "kubernets的网络插件：flannel"
date: 2017-01-18 00:11:12
author: 伊布
categories: tech
tags: kubernets
cover:  "/assets/instacode.png"
---

kubernets的网络，从设计上来讲是“扁平、直接”的，即：

- 所有容器可以不使用NAT技术就可以与其他容器通信
- 所有节点(物理机 虚拟机 容器)都可以不使用NAT同容器通信
- 容器看到的IP地址和别的机器看到的IP是一致的

### docker的网络方案

docker的网络支持如下四种：

- none
- host，与宿主机共享，占用宿主机资源
- container，使用某容器的namespace，例如k8s的同一pod内的各个容器
- bridge，挂到网桥docker0上，走iptables做NAT

实际上还有一种方法：先以none的方式run起来容器，然后使用pipework为容器增加一个veth网卡，该veth的另一端挂到新建的网桥br0上；再将宿主机的物理网卡挂到该网桥br0上：

```
[容器内eth0]--veth--br0--en0-->
```

需要注意这种方法与bridge的不同。docker0的网段是172.17.0.1/16，当bridge模式时，容器的ip地址均为此网段下的，报文是走NAT出去的。但pipework时，br0、[eth0]均与宿主机的en0同一网段，报文走网桥转发出去。

docker的网络能否满足需求呢？

bridge模式下，不同物理机的容器ip是完全的平行空间，可能相同，不能满足k8s扁平的要求；pipework方式能够满足k8s的要求，但是需要为每个容器都指定ip地址，比较啰嗦。


### k8s的flannel模式


k8s本身并不提供网络方案，而是交给flannel，ovs等add-on来处理。这里只对flannel做说明。

#### 架构

官方图还是很清楚的。flannel是一种over-lay网络：用户数据在进入实际物理网络之前，会经过一层UDP封装，

![o](https://github.com/coreos/flannel/blob/master/packet-01.png)




Tun/Tap口

[IBM](https://www.ibm.com/developerworks/cn/linux/l-tuntap/)

vxlan

防火墙




---
