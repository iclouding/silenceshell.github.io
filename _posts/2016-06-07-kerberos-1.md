---
layout: post
title: "Kerberos从入门到放弃（一）：HDFS使用kerberos"
date: 2016-06-07 00:11:11
author: 伊布
categories: tech
tags: kerberos
cover:  "/assets/instacode.png"
---

本文尝试记录HDFS各服务配置使用kerberos的过程，配置的东西比较多，**一定会有疏漏**。

我的环境：
三台服务器，分别命名为zelda1、zelda2、zelda3
ubuntu 14.04
hadoop 2.7.2


### 原理

默认Hadoop各个组件间无任何认证，因此可以恶意伪装某一组件（比如NameNode）接入到集群中造成破坏。通过kerberos，可以将密钥事先放到可靠的节点上并只允许有限制的访问，该节点的服务启动时读取密钥，并与kerberos交互以做认证，从而接入到hadoop集群中。注意，我们这里主要是针对服务与服务之间的安全认证，没有涉及user。

有很多文章讲解Kerberos的原理，或是过于简单或是过于复杂，下面盗用网上翻译的官方示例，可以很清晰的理解其过程：

用户要去游乐场，首先要在门口检查用户的身份(即 CHECK 用户的 ID 和 PASS), 如果用户通过验证，游乐场的门卫 (AS) 即提供给用户一张门卡 (TGT)。
这张卡片的用处就是告诉游乐场的各个场所，用户是通过正门进来，而不是后门偷爬进来的，并且也是获取进入场所一把钥匙。
现在用户有张卡，但是这对用户来不重要，因为用户来游乐场不是为了拿这张卡的而是为了游览游乐项目，这时用户摩天楼，并想游玩。
这时摩天轮的服务员 (client) 拦下用户，向用户要求摩天轮的 (ST) 票据，用户说用户只有一个门卡 (TGT), 那用户只要把 TGT 放在一旁的票据授权机 (TGS) 上刷一下。
票据授权机 (TGS) 就根据用户现在所在的摩天轮，给用户一张摩天轮的票据 (ST), 这样用户有了摩天轮的票据，现在用户可以畅通无阻的进入摩天轮里游玩了。
当然如果用户玩完摩天轮后，想去游乐园的咖啡厅休息下，那用户一样只要带着那张门卡 (TGT). 到相应的咖啡厅的票据授权机 (TGS) 刷一下，得到咖啡厅的票据 (ST) 就可以进入咖啡厅
当用户离开游乐场后，想用这张 TGT 去刷打的回家的费用，对不起，用户的 TGT 已经过期了，在用户离开游乐场那刻开始，用户的 TGT 就已经销毁了。

下面还有张图。

![原理图](http://7xir15.com1.z0.glb.clouddn.com/cas.png)

| Term | Description |
|--------|--------|
| Key Distribution Center, or KDC       |   可信任的认证来源，密钥分发中心     |
| Kerberos KDC Server | KDS服务提供者 |
| Kerberos Client | 集群中准备去做kerberos认证的机器 |
| Principal | The unique name of a user or service that authenticates against the KDC |
| Keytab | A file that includes one or more principals and their keys.当不方便使用密码的时候 |
| Realm | 我简单理解为域 |
| KDC Admin Account | 管理员账户，用来添加其他principal |


Principal可以理解为用户或服务的名字，全集群唯一，由三部分组成：username(or servicename)/instance@realm，例如：nn/zelda1@ZELDA.COM，zelda1为集群中的一台机器。

- username or servicename：在本文里为服务，HDFS的2个服务分别取名为nn和dn，即namenode和datanode
- instance：在本文里为具体的FQDN机器名，用来保证全局唯一（比如多个datanode节点，各节点需要各自独立认证）
- realm：域，我这里为ZELDA.COM（全大写哟）

对于HDFS的各个服务来说，keytab更合适：生成一个keytab文件，其包含一个或多个principal+key对，例如在HDFS配置文件里为nn指定的keytab文件：

```xml
<property>
  <name>dfs.namenode.keytab.file</name>
  <value>/etc/security/nn.service.keytab</value>
</property>
<property>

```

### 配置

#### 配置DNS服务

如上所述，Principal中的instance为各主机的FQDN名，所以集群中需要有DNS，这里我们用的是dnsmasq，相对比较简单。
简单说明下DNS：DNS是一个递归服务，以查询zh.wikipedia.org为例：

客户端发送查询报文"query zh.wikipedia.org"至DNS服务器，DNS服务器首先检查自身缓存，如果存在记录则直接返回结果。
如果记录老化或不存在，则

1. DNS服务器向根域名服务器发送查询报文"query zh.wikipedia.org"，根域名服务器返回.org域的权威域名服务器地址，这一级首先会返回的是顶级域名的权威域名服务器。
2. DNS服务器向.org域的权威域名服务器发送查询报文"query zh.wikipedia.org"，得到.wikipedia.org域的权威域名服务器地址。
3. DNS服务器向.wikipedia.org域的权威域名服务器发送查询报文"query zh.wikipedia.org"，得到主机zh的A记录，存入自身缓存并返回给客户端。

我们平时上网配置的杭州电信DNS地址（202.101.172.35），对于PC来说只要有DNS解析的需求，都会丢给这个地址的服务器（即为hzdns1）上，那么全球这么多国家这么多地址，显然不可能都存在杭州电信的hzdns1上，所以它会继续向上一直到根服务器请求解析。
所以，在我们这里其实可以自己架设了一个dns缓存服务器，集群内所有的DNS请求都先走这个服务器，如果查询失败，再由这台DNS缓存服务器向上查询；同时，我们也可以将集群内各个主机的主机名加到DNS缓存服务器里，这样集群内的FQDN解析就可以通过这个DNS缓存服务器来完成了（当然，需要将各个机器的DNS nameserver配置为集群内的DNS缓存服务器）。多说一句，对于企业内已有自建DNS的情况，加个接入级的DNS服务器对已有拓扑无任何影响。

我的操作系统是ubuntu 14.04，安装比较简单，sudo apt-get install dnsmasq即可。不过我人品比较好，遇到了网易163的ubuntu源错乱的情况，怎么也get不了，总是提示xx包被依赖但不会被安装，换用aliyun的源正常了。如果你在杭州，建议更换，服务器在杭州电信，速度特别好：

```xml
deb http://mirrors.aliyun.com/ubuntu/ trusty main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ trusty-security main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ trusty-updates main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ trusty-backports main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ trusty-proposed main restricted universe multiverse
```

安装后需要做配置，可以参考我的：

```
no-resolv
no-poll
server=202.101.172.35
domain=zelda.com
```

配置upstream DNS有两个办法：

1. 从resolv.conf(or compatible)文件中获取。但我在配置resolv-file=的时候遇到了些障碍，如果用这种方式，发现dnsmasq总是会请求一个61.x.x.x的DNS地址（温州电信的DNS）作为其upstream DNS，但其实这个DNS已经故障不能访问了，即使不用resolv.conf新增一个文件也不能解决。
2. 指定no-resolv，直接在dnsmasq的配置文件中指定upstream server，对我来说好使。

检查DNS服务：各机器的/etc/resolv.conf修改为dnsmasq服务所在机器的地址(zelda2)，ping集群内各机器的FQDN，如ping zelda1、ping zelda1.zelda.com。

#### 配置NTP



#### 创建MIT KDC

跟centos、Suse不一样，UBUNTU的Kr5安装时会提示KDC的realm、服务提供者


http://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.4.0/bk_Security_Guide/content/_optional_install_a_new_mit_kdc.html









主要参考hortonworks[官网](http://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.4.0/bk_Security_Guide/content/kerberos-overview.html)