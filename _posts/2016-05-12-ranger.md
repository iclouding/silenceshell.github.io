---
layout: post
title: "Apache Ranger：统一授权管理框架"
date: 2016-05-12 08:11:12
author: 伊布
categories: tech
tags: ranger
cover:  "/assets/instacode.png"
---

前一篇文章介绍了hive的授权模型和spark支持hive的现状，可以看到目前授权管理各自为政：HDFS，hive，yarn，storm等都有自己的授权模型，需要到具体产品下进行修改，比较分散，不利于统一管理，需要有一个集中控制的工具（更准确的应该叫做框架）

目前已有的统一授权管理的开源框架为Ranger和Sentry。前者由hortonworks主推，从目前的情况来看其功能更为全面（例如可以支持hive的列级授权，支持审计Audit）；后者由Cloudera开发，可能更有后劲。另外Cloudera在酝酿一个安全平台。

其他还有knox安全网关这种剑走偏锋的工具，简要说明可以参见[五种安全工具对比](https://www.xplenty.com/blog/2014/11/5-hadoop-security-projects/)。
这里简要介绍下Ranger的功能，以及其大致机制。


### 1、功能

我用的是Hortonworks的sandbox，略过了ranger的安装部署过程（具体部署可以参考[这篇文章](http://shenliang1985.blog.163.com/blog/static/2908380520151126102050593/)，后面有时间还是再做一次部署）。

先介绍几个概念：

- user: Ranger自己管理的用户，分为internal和external，前者为Ranger自己的用户，例如admin；后者为linux的用户，在操作系统里新增用户后会同步到Ranger。
- group: Ranger自己管理的用户组，没有内外之分，我们看到用户的组应该是Ranger自动生成的，跟linux的用户组无关。
- Service: 即授权管理服务，每个组件可以设置多个Service。
- Policy: 每个Service中可以有多条Policy，组件不同，Policy授权模型不同

#### 支持组件

已经支持的有HDFS/HBASE/HIVE/YARN/KNOX/STORM/SOLR/KAFKA。有的资料上说Ranger后面会支持spark，比较好奇最终会怎么实现。

#### 用户/组管理

Ranger的用户/组的设计跟linux基本一致。Ranger可以把操作系统新增的用户同步到Ranger内。Ranger支持Role，但没有看到完善的RBAC的功能，只有Admin/User两个角色。用户可以属于多个组，但是一旦新建后就不能修改还是挺不好用的。

#### 授权
以Hive为例。

1、编辑Service的属性
也可以删掉新建。默认沙箱里只给ambari-qa授权，不过我这里之前给hive做过授权，所以填了hive。需要保证Hive Service可用。

![](http://7xir15.com1.z0.glb.clouddn.com/ranger-hive-1.png)

2、编辑Policy
Ranger支持的权限比较细，授权对象可以是DB、表、列、UDF，权限类型包括select/update/create/drop/alter/index等等。
可以选择对某一用户授权，也可以对某一用户组授权。我这里给hive授予了一个表的所有权限。

![](http://7xir15.com1.z0.glb.clouddn.com/ranger-hive-2.png)

3、验证
在beeline中使用hive连上hive服务，验证其权限，略。


注意，也可以不经过Ranger，用户A直接在hive上向用户B授权，也是可以的；usersync会将该配置向上同步给Ranger，因此最终也可以生效。
**不是很确定是只走Ranger，还是跟HDFS一样先Ranger再HDFS自己。**

下面是最终的Policy，第三条即为向上同步的grant。

![](http://7xir15.com1.z0.glb.clouddn.com/ranger-hive-3.png)

#### 审计

Ranger提供4个方面的审计：

- Access：记录各个服务的接入信息
- Admin：记录Ranger的运维信息
- Login Sessions：记录用户登录Ranger信息
- Plugins：记录各个Plugin的同步信息

![](http://7xir15.com1.z0.glb.clouddn.com/ranger-hive-4.png)

Ranger不提供认证的功能，需要搭配Kerbose。

### 2、机制

分为如下几部分：

- ranger-admin：提供web server以及Ranger管理
- ranger-usersync：同步，将用户基于ranger的修改同步到具体的组件；将linux新增的用户、具体组件的权限修改等向上同步给ranger，。注意这个过程有个时间差，**最快1分钟**。
- ranger-xxx-plugin为针对各组件的插件。

#### 组件plugin

Ranger会将各个组件的plugin编译成jar包，并将jar包配置文件拷贝到对应的组件。以hdfs为例，插件enable的时候，会将ranger*plugin*.jar拷贝的hadoop的lib中，将ranger*.xml拷贝到./etc/hadoop/中，并修改hdfs-site.xml，增加授权provider：

```
    <property>
      <name>dfs.namenode.inode.attributes.provider.class</name>
      <value>org.apache.ranger.authorization.hadoop.RangerHdfsAuthorizer</value>
    </property>
```

RangerHdfsAuthorizer即为权限检查的类。不同的组件，使用对应组件的的鉴权框架。余愚钝，没能看懂hdfs或者hive的鉴权逻辑，慢慢再看。



参考资料：
[Ranger官方](https://cwiki.apache.org/confluence/display/RANGER/Apache+Ranger+0.5+-+User+Guide)

