<!DOCTYPE html>
<html>

	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?28bfa356a7c60e170822a01142cf208e";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Spark（一）：介绍、初体验</title>
  <meta name="description" content="1 介绍Spark是一个快速、通用的集群计算系统，提供JAVA/Scala/Python API，以及一系列的高级工具：Spark SQL/MLib/GrapyX/Spark Streaming.Spark的编程语言是scala，同样采用scala的还有kafka。2 安装我的环境使用的是CDH版本，安装时选上了...">
  
  <meta name="author" content="伊布">
  <meta name="copyright" content="&copy; 伊布 2016">
  

  <!-- External libraries -->
  <!--<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"> -->
  <link href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/solarized-dark.min.css">
  <!--<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/monokai_sublime.min.css">-->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/css/lightbox.css">

  <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
  <link rel="shortcut icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
  <link rel="manifest" href="/assets/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  
  <!-- Facebook OGP cards -->
  <meta property="og:description" content="1 介绍Spark是一个快速、通用的集群计算系统，提供JAVA/Scala/Python API，以及一系列的高级工具：Spark SQL/MLib/GrapyX/Spark Streaming.Spark的编程语言是scala，同样采用scala的还有kafka。2 安装我的环境使用的是CDH版本，安装时选上了..." />
  <meta property="og:url" content="http://silenceshell.gitcafe.io" />
  <meta property="og:site_name" content="Zlatan Eevee" />
  <meta property="og:title" content="Spark（一）：介绍、初体验" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="http://silenceshell.gitcafe.io/assets/instacode.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="612" />
  <meta property="og:image:height" content="605" />
  

  
  <!-- Twitter: card tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Spark（一）：介绍、初体验">
  <meta name="twitter:description" content="1 介绍Spark是一个快速、通用的集群计算系统，提供JAVA/Scala/Python API，以及一系列的高级工具：Spark SQL/MLib/GrapyX/Spark Streaming.Spark的编程语言是scala，同样采用scala的还有kafka。2 安装我的环境使用的是CDH版本，安装时选上了...">
  <meta name="twitter:image" content="http://silenceshell.gitcafe.io/assets/instacode.png">
  <meta name="twitter:url" content="http://silenceshell.gitcafe.io">
  

  

  <!-- Site styles -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://silenceshell.gitcafe.io/tech/2015/05/13/spark-intro.html">
  <link rel="alternate" type="application/rss+xml" title="Zlatan Eevee" href="http://silenceshell.gitcafe.io/feed.xml" />
</head>


  <body>

    <header class="navigation" role="banner">
  <div class="navigation-wrapper">
    <a href="/" class="logo">
      
      <img src="/assets/logo.png" alt="Zlatan Eevee">
      
    </a>
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
      <i class="fa fa-bars"></i>
    </a>
    <nav role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu show">
        
          
          <li class="nav-link"><a href="/about/">About</a>
          
        
          
        
          
        
          
        
          
          <li class="nav-link"><a href="/posts/">Posts</a>
          
        
          
          <li class="nav-link"><a href="/typography/">Typography</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </ul>
    </nav>
  </div>
</header>


    <div class="page-content">
        <div class="post">

<div class="post-header-container has-cover" style="background-image: url(/assets/instacode.png);">
  <div class="scrim has-cover">
    <header class="post-header">
      <h1 class="title">Spark（一）：介绍、初体验</h1>
      <p class="info">by <strong>伊布</strong></p>
    </header>
  </div>
</div>

<div class="wrapper">



<section class="post-meta">
  <div class="post-date">May 13, 2015</div>
  <div class="post-categories">
  in 
    
    <a href="/category/tech">Tech</a>
    
  
  </div>
</section>  

<article class="post-content">
  <h3 id="section">1 介绍</h3>
<p>Spark是一个快速、通用的集群计算系统，提供JAVA/Scala/Python API，以及一系列的高级工具：Spark SQL/MLib/GrapyX/Spark Streaming.
Spark的编程语言是scala，同样采用scala的还有kafka。</p>

<h3 id="section-1">2 安装</h3>
<p>我的环境使用的是CDH版本，安装时选上了Spark，手动安装请参考官网。
如果将Spark安装到hadoop上，需要注意其版本依赖关系。如果你的Spark底层使用了HDFS做存储，而Spark的版本与默认的hadoop一定要不同的话，需要自行编译，改脚本没用。</p>

<h3 id="rdd">3 核心：RDD</h3>
<p>RDD(Resilient Distributed Datasets，弹性分布式数据集)模型的出现主要为了解决下面两个场景：</p>

<ul>
  <li>迭代计算</li>
  <li>交互式数据挖掘：同一数据子集进行Ad-hoc计算</li>
</ul>

<p>RDD解决了中间结果重用的问题，不再像MR模型必须写入HDFS。RDD具有下面两个特点：</p>

<ul>
  <li>分布式：分布在多个节点上，可以被并行处理；存储在HDFS或者RDD数据集，也可以缓存在内存中，从而被多个并行任务重用。</li>
  <li>容错：某个节点挂掉后，丢失的RDD可以重构。</li>
</ul>

<p>RDD支持两种操作：</p>

<ul>
  <li>转换。从现有RDD生成新的RDD，例如<code class="highlighter-rouge">map(func)</code>、<code class="highlighter-rouge">filter(func)</code>、<code class="highlighter-rouge">join()</code>等。</li>
  <li>动作。将操作结果返回驱动程序或者写入存储，例如<code class="highlighter-rouge">reduce(func)</code>、<code class="highlighter-rouge">count()</code>、<code class="highlighter-rouge">saveAsTextFile()</code></li>
</ul>

<p>RDD还支持缓存，主要用在迭代计算中，转换时不用<em>再次计算</em>，用户可以用persist/cache等方法使中间结果的RDD数据集缓存在内存或磁盘中。
有关RDD的详细研究，可以参考CSDN的<a href="http://blog.csdn.net/wwwxxdddx/article/details/45647761">这篇文章</a>。</p>

<h3 id="section-2">4 基本架构</h3>

<p>Spark会将一个应用程序转为一组任务，分布在多个节点并行计算，并提供一个共享变量在这些并行任务间、任务与驱动程序间共享。
每个应用程序一套运行时环境，其生命周期如下：</p>

<ul>
  <li>准备运行时环境：资源管理。目前spark可以使用mesos（粗细两种粒度）/yarn（仅粗粒度）来作为其资源管理器。两种方式都需要BlockManager来管理RDD缓存。</li>
  <li>将任务转换为DAG图。RDD父子数据集间存在宽依赖、窄依赖。连续多个窄依赖可以归并到一个阶段并行。</li>
  <li>根据调度依赖关系执行DAG图。优化：数据本地性、推测执行。</li>
  <li>销毁运行时环境</li>
</ul>

<h3 id="quick-start">5 Quick start</h3>
<p>下面基本是参照<a href="http://spark.apache.org/docs/latest/quick-start.html">spark官网示例</a>来的。
####5.1 spark shell
spark shell可以交互式的运行spark程序，可以查看中间运行结果，是个学习框架的好方法。</p>

<p>```
$ spark-shell
Welcome to
      <strong>__              __
     / __/</strong>  <strong>_ __</strong><em>/ /__
    _\ \/ _ \/ _ `/ <strong>/  ‘_/
   /</strong></em>/ .<em>_/_,</em>/<em>/ /</em>/_\   version 1.3.0
      /_/</p>

<p>Using Scala version 2.10.4 (Java HotSpot(TM) 64-Bit Server VM, Java 1.7.0_15)
…
scala&gt;
```</p>

<p>我们可以在shell中进行一些scala的操作。shell启动时会自动提供一个SparkContext对象，我们可以直接用这个对象来加载文件为RDD。</p>

<p><code class="highlighter-rouge">bash
scala&gt; val textFile = sc.textFile("pi.py")		#textFile为一个RDD
textFile: org.apache.spark.rdd.RDD[String] = pi.py MapPartitionsRDD[3] at textFile at &lt;console&gt;:21
scala&gt; textFile.count()		#RDD的action
res4: Long = 41
scala&gt; textFile.filter(line =&gt; line.contains("Spark")).count()
res7: Long = 2				#RDD的transformation+action，先生成
15/05/12 19:00:25 INFO DAGScheduler: Job 2 finished: count at &lt;console&gt;:24, took 0.184386 s
</code></p>

<p>spark也提供了一个python语言的shell，运行<code class="highlighter-rouge">pyspark</code>可以进去，使用起来跟scala类似，具体可以参见官网。</p>

<p>RDD提供了跨集群、内存级的<em>cache</em>功能，对于一些频繁访问的数据集生成缓存，可以提高效率。</p>

<p><code class="highlighter-rouge">bash
scala&gt; val linesWithSpark = textFile.filter(line =&gt; line.contains("Spark"))
scala&gt; linesWithSpark.collect()
res12: Array[String] = Array(from pyspark import SparkContext, "    sc = SparkContext(appName="PythonPi")")
scala&gt; linesWithSpark.cache()
res13: linesWithSpark.type = MapPartitionsRDD[5] at filter at &lt;console&gt;:23
scala&gt; linesWithSpark.count()
res16: Long = 2
scala&gt; linesWithSpark.count()
res17: Long = 2
</code></p>

<h4 id="self-contained-applications">5.2 Self-Contained Applications</h4>
<p>实际生产环境中不可能像上面这样交互式运行，还是要自包含的应用程序。下面我们举一个源代码里python的例子，scala和java需要配合sbt和maven，具体请参照官网。</p>

<p>```python
import sys
from random import random
from operator import add
from pyspark import SparkContext</p>

<p>if <strong>name</strong> == “<strong>main</strong>”:
    “””
        Usage: pi [partitions]
    “””
    sc = SparkContext(appName=”PythonPi”)			#sc要自己创建
    partitions = int(sys.argv[1]) if len(sys.argv) &gt; 1 else 2
    n = 100000 * partitions</p>

<div class="highlighter-rouge"><pre class="highlight"><code>def f(_):
    x = random() * 2 - 1
    y = random() * 2 - 1
    return 1 if x ** 2 + y ** 2 &lt; 1 else 0

count = sc.parallelize(xrange(1, n + 1), partitions).map(f).reduce(add)
print "Pi is roughly %f" % (4.0 * count / n)

sc.stop()	#停掉sc ```
</code></pre>
</div>

<p>简单来说，spark应用程序比shell方式多了SparkContext的创建、销毁，其他基本是一致的。
使用spark-submit将此python脚本提交到spark执行：</p>

<p><code class="highlighter-rouge">bash
$ spark-submit pi.py 10
15/05/12 19:42:26 INFO DAGScheduler: Job 0 finished: reduce at /opt/cloudera/parcels/CDH-5.4.0-1.cdh5.4.0.p0.27/lib/spark/examples/lib/pi.py:38, took 1.867190 s
Pi is roughly 3.142040
</code></p>

<p>如果python程序依赖其他的文件或第三方的lib库，可以将其打包为zip文件，用–py-files指定就可以了。python系统库不需要。</p>

<p>Spark提供了一个history web server，可以看到我们运行了的那些程序以及他们的详细信息。
<img src="http://7xir15.com1.z0.glb.clouddn.com/spark_jobs.PNG" alt="spark jobs" /></p>

</article>



<section class="tags">
  <strong>Tags:</strong> <a href="/tag/spark">spark</a>
</section>



<section class="rss">
  <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
</section>

<section class="share">
  <span>Share: </span>
  
    
    
      <a href="//twitter.com/share?text=Spark%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E4%BB%8B%E7%BB%8D%E3%80%81%E5%88%9D%E4%BD%93%E9%AA%8C&url=http://silenceshell.gitcafe.io/tech/2015/05/13/spark-intro.html&via=瓶子"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
        <i class="fa fa-twitter-square fa-lg"></i>
      </a>
    
    
    
    
    
  
    
    
    
    
    
    
  
</section>



</div>
</div>

    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h3 class="footer-heading">Zlatan Eevee</h3>

    <div class="site-navigation">
      
      <p><strong>Site Map</strong></p>
      <ul class="pages">
        
        
          <li class="nav-link"><a href="/about/">About</a>
        
        
        
        
        
        
        
        
        
          <li class="nav-link"><a href="/posts/">Posts</a>
        
        
        
          <li class="nav-link"><a href="/typography/">Typography</a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </ul>
    </div>

    <div class="site-contact">

      <p><strong>Contact</strong></p>
      <ul class="social-media-list">
        <li>
          <a href="mailto:hubottle@gmail.com">
            <i class="fa fa-envelope-o"></i>
            <span class="username">hubottle@gmail.com</span>
          </a>
        </li>

        
          
          <li>
            <a href="https://twitter.com/hubottle" title="Follow me on Twitter">
              <i class="fa fa-twitter"></i>
              <span class="username">瓶子</span>
            </a>
          </li>
          
        
          
          <li>
            <a href="https://github.com/silenceshell" title="Fork me on GitHub">
              <i class="fa fa-github"></i>
              <span class="username">silenceshell</span>
            </a>
          </li>
          
        

      </ul>
    </div>

    <div class="site-signature">
      <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
      <p class="text"></p>
    </div>

  </div>

</footer>

<!-- Scripts -->
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js"></script>
<script>

$(document).ready(function() {

  // Syntax highlighting
  hljs.initHighlightingOnLoad();

  // Header
  var menuToggle = $('#js-mobile-menu').unbind();
  $('#js-navigation-menu').removeClass("show");
  menuToggle.on('click', function(e) {
    e.preventDefault();
    $('#js-navigation-menu').slideToggle(function(){
      if($('#js-navigation-menu').is(':hidden')) {
        $('#js-navigation-menu').removeAttr('style');
      }
    });
  });


});

</script>




  </body>

</html>
